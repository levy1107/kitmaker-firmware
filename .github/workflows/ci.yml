name: Build OTA Binary

on:
  push:
    paths:
      - "sketches/**"
      - ".github/workflows/ci.yml"

# ‚¨áÔ∏è  Permite que el job escriba en el repositorio
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        persist-credentials: true

    - name: Setup Arduino-CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ESP32 core
      run: |
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    - name: Install libraries
      run: |
        arduino-cli lib update-index
        arduino-cli lib install "Adafruit SSD1306" \
                                 "Adafruit GFX Library" \
                                 "Adafruit HTU21DF Library" \
                                 "Adafruit NeoPixel"

    - name: Prepare sketch
      run: |
        mkdir -p build/automatic
        cp sketches/automatic.ino build/automatic/automatic.ino

    - name: Compile & export bin
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32 \
          --export-binaries \
          build/automatic

    - name: Publish latest.bin
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir -p firmware
        BIN=$(find build/automatic -type f -name "*.bin" | head -n1)
        echo "Binario encontrado: $BIN"
        cp "$BIN" firmware/latest.bin
        git config user.name  "github-actions[bot]"
        git config user.email "actions@github.com"
        git add firmware/latest.bin
        git commit -m "üî® Build latest.bin"
        # Push autenticado con el token
        git push "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
