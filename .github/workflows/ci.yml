name: Build OTA Binary

on:
  push:
    paths:
      - "sketches/**"
      - ".github/workflows/ci.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        persist-credentials: true

    - name: Setup Arduino-CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ESP32 core
      run: |
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    - name: Install libraries
      run: |
        arduino-cli lib update-index
        arduino-cli lib install "Adafruit SSD1306" \
                                 "Adafruit GFX Library" \
                                 "Adafruit HTU21DF Library" \
                                 "Adafruit NeoPixel"

    # Arduino-CLI necesita carpeta y .ino con el mismo nombre
    - name: Prepare sketch
      run: |
        mkdir -p build/automatic
        cp sketches/automatic.ino build/automatic/automatic.ino

    - name: Compile & export .bin
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32 \
          --export-binaries \
          build/automatic

    - name: Publish latest.bin
      run: |
        mkdir -p firmware
        # busquemos recursivamente el primer .bin
        BIN=$(find build/automatic -type f -name "*.bin" | head -n1)
        echo "Bin encontrado: $BIN"
        if [ -z "$BIN" ]; then
          echo "‚ùå No se gener√≥ .bin"; exit 1
        fi
        cp "$BIN" firmware/latest.bin
        git config user.name  "github-actions[bot]"
        git config user.email "actions@github.com"
        git add firmware/latest.bin
        git commit -m "üî® Build latest.bin"
        git push
