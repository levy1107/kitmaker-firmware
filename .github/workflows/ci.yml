name: Build OTA Binary

on:
  push:
    paths:
      - "sketches/**"
      - ".github/workflows/ci.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        persist-credentials: true

    - name: Setup Arduino-CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ESP32 core
      run: |
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    - name: Install required libs
      run: |
        arduino-cli lib update-index
        arduino-cli lib install "Adafruit SSD1306" \
                                 "Adafruit GFX Library" \
                                 "Adafruit HTU21DF Library" \
                                 "Adafruit NeoPixel"

    # â€”â€” preparar carpeta con mismo nombre que el .ino â€”â€”
    - name: Prepare sketch dir
      run: |
        mkdir -p build/automatic
        cp sketches/automatic.ino build/automatic/automatic.ino

    # â€”â€” compilar y exportar binarios â€”â€”
    - name: Compile sketch
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32 \
          --export-binaries \
          build/automatic

    # â€”â€” copiar primer .bin encontrado a firmware/latest.bin â€”â€”
    - name: Publish latest.bin
      run: |
        mkdir -p firmware
        BIN=$(find build/automatic -maxdepth 1 -name "*.bin" | head -n1)
        echo "Binario => $BIN"
        if [ -z "$BIN" ]; then
          echo "âŒ No se generÃ³ ningÃºn .bin"; exit 1
        fi
        cp "$BIN" firmware/latest.bin
        git config user.name  "github-actions[bot]"
        git config user.email "actions@github.com"
        git add firmware/latest.bin
        git commit -m "ğŸ”¨ Build latest.bin"
        git push
